<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CKART - CatBag & Orders</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --primary: #764ba2; --secondary: #667eea; --success: #2ecc71; --danger: #ff4757; }
        body { font-family: 'Segoe UI', sans-serif; background: #f1f3f6; margin: 0; padding-bottom: 30px; }

        /* --- Flipkart Style Tab System --- */
        .tab-bar { background: #2874f0; display: flex; position: sticky; top: 0; z-index: 1000; padding: 0 10%; }
        .tab-item { flex: 1; text-align: center; padding: 15px; cursor: pointer; font-weight: bold; color: white; border-bottom: 4px solid transparent; transition: 0.3s; font-size: 14px; }
        .tab-item.active { border-bottom: 4px solid white; background: rgba(255,255,255,0.1); }
        .home-link { background: #fb641b; color: white; text-decoration: none; padding: 15px 20px; font-weight: bold; display: flex; align-items: center; gap: 5px; }

        .container { max-width: 900px; margin: 20px auto; padding: 0 15px; }
        .content-section { display: none; }
        .content-section.active { display: block; }

        /* --- Cart List UI --- */
        .cart-card { background: white; padding: 20px; border-radius: 8px; display: flex; gap: 20px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); align-items: center; }
        .cart-card img { width: 100px; height: 100px; object-fit: contain; cursor: zoom-in; }
        .item-info { flex: 1; }
        .qty-box { display: flex; align-items: center; gap: 15px; margin-top: 10px; }
        .qty-btn { border: 1px solid #ddd; background: white; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-weight: bold; }
        
        .checkout-box { background: white; padding: 20px; border-radius: 8px; text-align: right; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); }
        .order-now-btn { background: #fb641b; color: white; border: none; padding: 15px 40px; font-size: 18px; font-weight: bold; cursor: pointer; border-radius: 3px; }

        /* --- My Order UI --- */
        .order-card { background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #ddd; position: relative; }
        .order-header { display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 10px; font-size: 13px; color: #666; }
        .status-badge { color: var(--primary); font-weight: bold; display: flex; align-items: center; gap: 5px; margin-top: 10px; font-size: 12px; }
        .cancel-btn { background: none; border: 1px solid var(--danger); color: var(--danger); padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; margin-top: 10px; }

        /* --- Image Preview Modal --- */
        #imgModal { display: none; position: fixed; z-index: 2000; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); justify-content: center; align-items: center; }
        #imgModal img { max-width: 90%; max-height: 80%; border-radius: 10px; }
        .close-modal { position: absolute; top: 20px; right: 30px; color: white; font-size: 40px; cursor: pointer; }
    </style>
</head>
<body>

<div class="tab-bar">
    <a href="index.html" class="home-link"><i class="fas fa-home"></i> HOME</a>
    <div class="tab-item active" onclick="switchTab(event, 'cart-list')">1-CART LIST</div>
    <div class="tab-item" onclick="switchTab(event, 'my-order')">2-MY ORDER</div>
</div>

<div class="container">
    <div id="cart-list" class="content-section active">
        <div id="cartItemsContainer"></div>
        <div class="checkout-box">
            <h3>Total Price: ₹<span id="totalPrice">0</span></h3>
            <button class="order-now-btn" onclick="placeOrder()">ORDER NOW</button>
        </div>
    </div>

    <div id="my-order" class="content-section">
        <div id="ordersContainer"></div>
    </div>
</div>

<div id="imgModal">
    <span class="close-modal" onclick="closePreview()">&times;</span>
    <img id="modalImg" src="">
</div>

<script type="module">
    import { supabase } from './supabaseClient.js';

    let cart = JSON.parse(localStorage.getItem('cart')) || [];

    // --- Tab Switcher ---
    window.switchTab = (e, tab) => {
        document.querySelectorAll('.content-section, .tab-item').forEach(el => el.classList.remove('active'));
        document.getElementById(tab).classList.add('active');
        e.currentTarget.classList.add('active');
        if(tab === 'my-order') loadOrders();
    };

    // --- Big Image Preview ---
    window.previewImg = (url) => {
        document.getElementById('modalImg').src = url;
        document.getElementById('imgModal').style.display = 'flex';
    };
    window.closePreview = () => document.getElementById('imgModal').style.display = 'none';

    // --- Render Cart ---
    function renderCart() {
        const container = document.getElementById('cartItemsContainer');
        let total = 0;
        if(cart.length === 0) {
            container.innerHTML = "<p style='text-align:center; padding:50px;'>আপনার কার্ট ব্যাগ খালি!</p>";
            document.getElementById('totalPrice').innerText = "0";
            return;
        }

        container.innerHTML = cart.map((item, i) => {
            const price = parseFloat(item.price);
            total += price * item.qty;
            return `
                <div class="cart-card">
                    <img src="${item.image_url}" onclick="previewImg('${item.image_url}')">
                    <div class="item-info">
                        <h3 style="margin:0;">${item.name}</h3>
                        <p style="color:var(--success); font-weight:bold;">₹${price}</p>
                        <div class="qty-box">
                            <button class="qty-btn" onclick="updateQty(${i}, -1)">-</button>
                            <span>${item.qty}</span>
                            <button class="qty-btn" onclick="updateQty(${i}, 1)">+</button>
                            <button onclick="removeCart(${i})" style="border:none; color:var(--danger); background:none; cursor:pointer; margin-left:20px;">REMOVE</button>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
        document.getElementById('totalPrice').innerText = total;
    }

    window.updateQty = (i, n) => {
        cart[i].qty += n;
        if(cart[i].qty < 1) cart.splice(i, 1);
        localStorage.setItem('cart', JSON.stringify(cart));
        renderCart();
    };

    window.removeCart = (i) => {
        cart.splice(i, 1);
        localStorage.setItem('cart', JSON.stringify(cart));
        renderCart();
    };

    // --- Order ID Logic (CK00000001) ---
    async function getNextOrderId() {
        const { count } = await supabase.from('orders').select('*', { count: 'exact', head: true });
        return "CK" + (count + 1).toString().padStart(8, '0');
    }

    // --- Place Order ---
    window.placeOrder = async () => {
        const { data: { user } } = await supabase.auth.getUser();
        if(!user) return alert("দয়া করে লগইন করুন!");

        const orderId = await getNextOrderId();
        const orderData = cart.map(item => ({
            order_id: orderId,
            consumer_id: user.id,
            product_name: item.name,
            product_code: item.product_code || 'N/A',
            category: item.category || 'General',
            price: item.price,
            total_qty: item.qty,
            image_url: item.image_url,
            status: 'ORDER PICKUP PENDING'
        }));

        const { error } = await supabase.from('orders').insert(orderData);
        if(!error) {
            alert("অর্ডার সফল হয়েছে! ID: " + orderId);
            localStorage.removeItem('cart');
            location.reload();
        }
    };

    // --- Load Orders ---
    async function loadOrders() {
        const { data: { user } } = await supabase.auth.getUser();
        const container = document.getElementById('ordersContainer');
        const { data } = await supabase.from('orders').select('*').eq('consumer_id', user.id).order('created_at', { ascending: false });

        if(data) {
            container.innerHTML = data.map(order => `
                <div class="order-card">
                    <div class="order-header">
                        <span>ID: ${order.order_id}</span>
                        <span>${new Date(order.created_at).toLocaleDateString()}</span>
                    </div>
                    <div style="display:flex; gap:15px; align-items:center;">
                        <img src="${order.image_url}" width="60" onclick="previewImg('${order.image_url}')" style="cursor:pointer;">
                        <div>
                            <div style="font-weight:bold;">${order.product_name}</div>
                            <div style="font-size:12px; color:#888;">Code: ${order.product_code} | Cat: ${order.category}</div>
                            <div style="color:var(--success); font-weight:bold;">₹${order.price} x ${order.total_qty}</div>
                        </div>
                    </div>
                    <div class="status-badge"><i class="fas fa-briefcase"></i> STATUS: ${order.status}</div>
                    ${order.status !== 'CANCELLED' ? `<button class="cancel-btn" onclick="cancelRequest('${order.id}')">Order Cancelled Request</button>` : ''}
                </div>
            `).join('');
        }
    }

    window.cancelRequest = async (id) => {
        if(confirm("আপনি কি অর্ডারটি ক্যান্সেল করতে চান?")) {
            await supabase.from('orders').update({ status: 'CANCEL REQUESTED' }).eq('id', id);
            alert("ক্যান্সেল রিকোয়েস্ট পাঠানো হয়েছে!");
            loadOrders();
        }
    };

    renderCart();
</script>
</body>
</html>
