<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CKART - CatBag & Orders</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --primary: #2874f0; --secondary: #764ba2; --success: #2ecc71; --danger: #ff4757; }
        body { font-family: 'Segoe UI', sans-serif; background: #f1f3f6; margin: 0; padding-bottom: 30px; }

        /* --- Flipkart Style Tab System --- */
        .tab-bar { background: var(--primary); display: flex; position: sticky; top: 0; z-index: 1000; padding: 0 5%; align-items: center; }
        .tab-item { flex: 1; text-align: center; padding: 15px; cursor: pointer; font-weight: bold; color: white; border-bottom: 4px solid transparent; transition: 0.3s; font-size: 14px; text-transform: uppercase; }
        .tab-item.active { border-bottom: 4px solid white; background: rgba(255,255,255,0.1); }
        .home-link { background: #fb641b; color: white; text-decoration: none; padding: 15px 20px; font-weight: bold; display: flex; align-items: center; gap: 8px; }

        .container { max-width: 900px; margin: 20px auto; padding: 0 15px; }
        .content-section { display: none; }
        .content-section.active { display: block; }

        /* --- Cart List UI --- */
        .cart-card { background: white; padding: 20px; border-radius: 8px; display: flex; gap: 20px; margin-bottom: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); align-items: center; border: 1px solid #e0e0e0; }
        .cart-card img { width: 100px; height: 100px; object-fit: contain; cursor: zoom-in; border: 1px solid #f0f0f0; border-radius: 4px; }
        .item-info { flex: 1; }
        .qty-box { display: flex; align-items: center; gap: 15px; margin-top: 10px; }
        .qty-btn { border: 1px solid #ddd; background: white; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-weight: bold; font-size: 18px; display: flex; align-items: center; justify-content: center; }
        .qty-btn:hover { background: #f9f9f9; }
        
        .checkout-box { background: white; padding: 20px; border-radius: 8px; text-align: right; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-top: 20px; border: 1px solid #e0e0e0; }
        .order-now-btn { background: #fb641b; color: white; border: none; padding: 15px 40px; font-size: 18px; font-weight: bold; cursor: pointer; border-radius: 3px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .order-now-btn:disabled { background: #ccc; cursor: not-allowed; }

        /* --- My Order UI --- */
        .order-card { background: white; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #ddd; position: relative; }
        .order-header { display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 10px; font-size: 13px; color: #666; font-weight: 600; }
        .status-badge { color: var(--secondary); font-weight: bold; display: flex; align-items: center; gap: 8px; margin-top: 10px; font-size: 13px; background: #f0f5ff; padding: 8px; border-radius: 4px; border: 1px solid #d0e0ff; }
        .cancel-btn { background: white; border: 1px solid var(--danger); color: var(--danger); padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; margin-top: 10px; font-weight: 600; transition: 0.3s; }
        .cancel-btn:hover { background: var(--danger); color: white; }

        /* --- Image Preview Modal --- */
        #imgModal { display: none; position: fixed; z-index: 2000; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); justify-content: center; align-items: center; }
        #imgModal img { max-width: 90%; max-height: 80%; border-radius: 10px; box-shadow: 0 0 20px rgba(255,255,255,0.2); }
        .close-modal { position: absolute; top: 20px; right: 30px; color: white; font-size: 40px; cursor: pointer; }
    </style>
</head>
<body>

<div class="tab-bar">
    <a href="index.html" class="home-link"><i class="fas fa-home"></i> HOME</a>
    <div class="tab-item active" id="tab-cart" onclick="switchTab(event, 'cart-list')">1-CART LIST</div>
    <div class="tab-item" id="tab-orders" onclick="switchTab(event, 'my-order')">2-MY ORDER</div>
</div>

<div class="container">
    <div id="cart-list" class="content-section active">
        <div id="cartItemsContainer"></div>
        <div class="checkout-box" id="checkoutBox">
            <h3>Total Amount: ₹<span id="totalPrice">0</span></h3>
            <button class="order-now-btn" id="orderBtn" onclick="placeOrder()">ORDER NOW</button>
        </div>
    </div>

    <div id="my-order" class="content-section">
        <div id="ordersContainer"></div>
    </div>
</div>

<div id="imgModal" onclick="closePreview()">
    <span class="close-modal" onclick="closePreview()">&times;</span>
    <img id="modalImg" src="">
</div>

<script type="module">
    import { supabase } from './supabaseClient.js';

    let cart = JSON.parse(localStorage.getItem('cart')) || [];

    // --- Tab Switcher ---
    window.switchTab = (e, tab) => {
        document.querySelectorAll('.content-section, .tab-item').forEach(el => el.classList.remove('active'));
        document.getElementById(tab).classList.add('active');
        e.currentTarget.classList.add('active');
        if(tab === 'my-order') loadOrders();
        if(tab === 'cart-list') renderCart();
    };

    // --- Big Image Preview ---
    window.previewImg = (url) => {
        document.getElementById('modalImg').src = url;
        document.getElementById('imgModal').style.display = 'flex';
    };
    window.closePreview = () => document.getElementById('imgModal').style.display = 'none';

    // --- Render Cart ---
    function renderCart() {
        const container = document.getElementById('cartItemsContainer');
        const checkout = document.getElementById('checkoutBox');
        let total = 0;
        
        if(cart.length === 0) {
            container.innerHTML = `
                <div style='text-align:center; padding:100px 20px; background:white; border-radius:8px;'>
                    <i class="fas fa-shopping-bag fa-4x" style="color:#ddd; margin-bottom:20px;"></i>
                    <p style="font-size:18px; color:#666;">আপনার কার্ট ব্যাগ খালি!</p>
                    <a href="index.html" style="color:var(--primary); font-weight:bold; text-decoration:none;">এখনই কেনাকাটা করুন</a>
                </div>`;
            checkout.style.display = "none";
            return;
        }

        checkout.style.display = "block";
        container.innerHTML = cart.map((item, i) => {
            const price = parseFloat(item.price);
            total += price * item.qty;
            return `
                <div class="cart-card">
                    <img src="${item.image_url}" onclick="previewImg('${item.image_url}')" title="Click to zoom">
                    <div class="item-info">
                        <h3 style="margin:0; color:#333;">${item.name}</h3>
                        <p style="color:var(--success); font-weight:bold; font-size:18px; margin:5px 0;">₹${price}</p>
                        <div class="qty-box">
                            <button class="qty-btn" onclick="updateQty(${i}, -1)">-</button>
                            <span style="font-weight:bold; font-size:16px; min-width:20px; text-align:center;">${item.qty}</span>
                            <button class="qty-btn" onclick="updateQty(${i}, 1)">+</button>
                            <button onclick="removeCart(${i})" style="border:none; color:var(--danger); background:none; cursor:pointer; margin-left:20px; font-weight:bold;">REMOVE</button>
                        </div>
                    </div>
                </div>
            `;
        }).join('');
        document.getElementById('totalPrice').innerText = total;
    }

    window.updateQty = (i, n) => {
        cart[i].qty += n;
        if(cart[i].qty < 1) cart.splice(i, 1);
        localStorage.setItem('cart', JSON.stringify(cart));
        renderCart();
    };

    window.removeCart = (i) => {
        if(confirm("প্রোডাক্টটি রিমুভ করতে চান?")) {
            cart.splice(i, 1);
            localStorage.setItem('cart', JSON.stringify(cart));
            renderCart();
        }
    };

    // --- Order ID Logic (CK00000001) ---
    async function getNextOrderId() {
        const { count, error } = await supabase.from('orders').select('*', { count: 'exact', head: true });
        const nextNum = (count || 0) + 1;
        return "CK" + nextNum.toString().padStart(8, '0');
    }

    // --- Place Order ---
    window.placeOrder = async () => {
        const orderBtn = document.getElementById('orderBtn');
        const { data: { session } } = await supabase.auth.getSession();
        
        if(!session) {
            alert("অর্ডার করতে দয়া করে আগে লগইন করুন!");
            window.location.href = 'login.html';
            return;
        }

        orderBtn.disabled = true;
        orderBtn.innerText = "Processing...";

        try {
            const orderId = await getNextOrderId();
            const user = session.user;

            const orderEntries = cart.map(item => ({
                order_id: orderId,
                consumer_id: user.id,
                product_name: item.name,
                product_code: item.product_code || 'CK-PROD',
                category: item.category || 'General',
                price: parseFloat(item.price),
                total_qty: item.qty,
                image_url: item.image_url,
                status: 'ORDER PICKUP PENDING'
            }));

            const { error } = await supabase.from('orders').insert(orderEntries);

            if(error) throw error;

            alert("অর্ডার সফল হয়েছে! আপনার অর্ডার আইডি: " + orderId);
            localStorage.removeItem('cart');
            cart = [];
            switchTab({ currentTarget: document.getElementById('tab-orders') }, 'my-order');

        } catch (err) {
            alert("অর্ডার করতে সমস্যা হয়েছে: " + err.message);
        } finally {
            orderBtn.disabled = false;
            orderBtn.innerText = "ORDER NOW";
        }
    };

    // --- Load My Orders ---
    async function loadOrders() {
        const container = document.getElementById('ordersContainer');
        const { data: { session } } = await supabase.auth.getSession();

        if(!session) {
            container.innerHTML = "<p style='text-align:center; padding:50px;'>অর্ডার দেখতে লগইন করুন।</p>";
            return;
        }

        const { data, error } = await supabase
            .from('orders')
            .select('*')
            .eq('consumer_id', session.user.id)
            .order('created_at', { ascending: false });

        if(data && data.length > 0) {
            container.innerHTML = data.map(order => `
                <div class="order-card">
                    <div class="order-header">
                        <span><i class="fas fa-hashtag"></i> ${order.order_id}</span>
                        <span><i class="far fa-calendar-alt"></i> ${new Date(order.created_at).toLocaleDateString()}</span>
                    </div>
                    <div style="display:flex; gap:15px; align-items:center;">
                        <img src="${order.image_url}" width="70" height="70" style="object-fit:cover; border-radius:5px; border:1px solid #eee; cursor:pointer;" onclick="previewImg('${order.image_url}')">
                        <div style="flex:1;">
                            <div style="font-weight:bold; font-size:15px; color:#333;">${order.product_name}</div>
                            <div style="font-size:12px; color:#888; margin:3px 0;">Code: ${order.product_code} | Cat: ${order.category}</div>
                            <div style="color:var(--success); font-weight:bold;">₹${order.price} x ${order.total_qty}</div>
                        </div>
                    </div>
                    <div class="status-badge">
                        <i class="fas fa-shopping-bag"></i> STATUS: ${order.status}
                    </div>
                    ${order.status === 'ORDER PICKUP PENDING' ? 
                        `<button class="cancel-btn" onclick="cancelRequest('${order.id}')">Order Cancelled Request</button>` : ''}
                </div>
            `).join('');
        } else {
            container.innerHTML = "<p style='text-align:center; padding:50px;'>আপনি এখনও কোনো অর্ডার করেননি।</p>";
        }
    }

    window.cancelRequest = async (id) => {
        if(confirm("আপনি কি এই অর্ডারটি ক্যানসেল করার জন্য রিকোয়েস্ট পাঠাতে চান?")) {
            const { error } = await supabase.from('orders').update({ status: 'CANCEL REQUESTED' }).eq('id', id);
            if(!error) {
                alert("রিকোয়েস্ট পাঠানো হয়েছে। অ্যাডমিন এটি চেক করবেন।");
                loadOrders();
            }
        }
    };

    // ইনিশিয়াল লোড
    renderCart();
</script>
</body>
</html>
