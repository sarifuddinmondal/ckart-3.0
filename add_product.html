<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Product - CKART Admin</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --primary: #764ba2; --bg: #f4f7f6; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; display: flex; justify-content: center; padding: 20px; }
        .form-container { background: white; padding: 30px; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); width: 100%; max-width: 600px; }
        h2 { text-align: center; color: var(--primary); margin-bottom: 25px; }
        
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 600; color: #444; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 15px; }
        
        .row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        
        .cat-flex { display: flex; gap: 10px; }
        .add-btn { background: var(--primary); color: white; border: none; padding: 0 15px; border-radius: 6px; cursor: pointer; }

        .image-upload-section { border: 2px dashed #ddd; padding: 20px; text-align: center; border-radius: 8px; cursor: pointer; transition: 0.3s; }
        .image-upload-section:hover { border-color: var(--primary); }
        .preview-img { max-width: 100px; margin-top: 10px; display: none; border-radius: 5px; }

        .submit-btn { width: 100%; padding: 15px; background: #27ae60; color: white; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 20px; }
        .submit-btn:hover { background: #219150; }

        /* Modal Style */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 25px; border-radius: 10px; width: 300px; text-align: center; }
    </style>
</head>
<body>

<div class="form-container">
    <h2>➕ নতুন প্রোডাক্ট যোগ করুন</h2>
    
    <div class="form-group">
        <label>ক্যাটাগরি</label>
        <div class="cat-flex">
            <select id="category" tabindex="1">
                <option value="Body Care">Body Care</option>
                <option value="Cosmetic">Cosmetic</option>
                <option value="Face Care">Face Care</option>
                <option value="Hair Care">Hair Care</option>
                <option value="Color Cosmetic">Color Cosmetic</option>
                <option value="Personal Care">Personal Care</option>
                <option value="Nail Care">Nail Care</option>
                <option value="Beauty Tools">Beauty Tools</option>
                <option value="Skin Care">Skin Care</option>
                <option value="Others">Others</option>
            </select>
            <button class="add-btn" type="button" onclick="openModal()" tabindex="2">Add</button>
        </div>
    </div>

    <div class="form-group">
        <label>প্রোডাক্টের নাম</label>
        <input type="text" id="pName" placeholder="সম্পূর্ণ নাম লিখুন" tabindex="3" required>
    </div>

    <div class="row">
        <div class="form-group">
            <label>MRP (₹)</label>
            <input type="number" id="mrp" placeholder="0.00" tabindex="4" required>
        </div>
        <div class="form-group">
            <label>ডিসকাউন্ট (%)</label>
            <input type="number" id="discount" placeholder="0" tabindex="5">
        </div>
    </div>
    <div class="form-group">
        <label>স্টক (Quantity)</label>
        <input type="number" id="stock" placeholder="কত পিস আছে?" tabindex="6" required>
    </div>

    <div class="row">
        <div class="form-group">
            <label>পরিমাণ (Value)</label>
            <input type="number" id="qtyVal" placeholder="উদা: ১০০" tabindex="7">
        </div>
        <div class="form-group">
            <label>ইউনিট</label>
            <select id="unit" tabindex="8">
                <option value="ml">ml</option>
                <option value="qty">qty/pcs</option>
                <option value="g">g</option>
                <option value="combo">combo</option>
            </select>
        </div>
    </div>

    <div class="form-group">
        <label>ওয়েব ইমেজ লিঙ্ক (ঐচ্ছিক)</label>
        <input type="url" id="webLink" placeholder="https://..." tabindex="9">
    </div>
    <div class="image-upload-section" onclick="document.getElementById('fileInput').click()" tabindex="10">
        <i class="fas fa-camera fa-2x"></i>
        <p>ক্লিক করে ছবি আপলোড করুন</p>
        <input type="file" id="fileInput" hidden accept="image/*" onchange="previewImage(this)">
        <img id="imgPreview" class="preview-img">
    </div>

    <button class="submit-btn" id="submitBtn" tabindex="11">OK / সাবমিট করুন</button>
</div>

<div id="catModal" class="modal">
    <div class="modal-content">
        <h3>নতুন ক্যাটাগরি</h3>
        <input type="text" id="newCatName" placeholder="ক্যাটাগরির নাম">
        <div class="cat-flex" style="margin-top:15px; justify-content:center;">
            <button class="add-btn" onclick="addCategory()">OK</button>
            <button class="add-btn" style="background:#888;" onclick="closeModal()">Cancel</button>
        </div>
    </div>
</div>

<script type="module">
    import { supabase } from './supabaseClient.js';

    // ১. মোডাল কন্ট্রোল
    window.openModal = () => document.getElementById('catModal').style.display = 'flex';
    window.closeModal = () => document.getElementById('catModal').style.display = 'none';

    // ২. নতুন ক্যাটাগরি যোগ (Dynamic)
    window.addCategory = () => {
        const name = document.getElementById('newCatName').value.trim();
        if(name) {
            const select = document.getElementById('category');
            const option = new Option(name, name);
            select.add(option, select.firstChild);
            select.value = name;
            closeModal();
            document.getElementById('newCatName').value = "";
        }
    };

    // ৩. ইমেজ প্রিভিউ
    window.previewImage = (input) => {
        const preview = document.getElementById('imgPreview');
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = (e) => {
                preview.src = e.target.result;
                preview.style.display = 'block';
            };
            reader.readAsDataURL(input.files[0]);
        }
    };

    // ৪. মেইন সাবমিশন
    document.getElementById('submitBtn').onclick = async () => {
        const btn = document.getElementById('submitBtn');
        const file = document.getElementById('fileInput').files[0];
        const webLink = document.getElementById('webLink').value;
        
        btn.disabled = true;
        btn.innerText = "সেভ হচ্ছে...";

        let finalImageUrl = webLink;

        // ফাইল আপলোড লজিক (সুপাবেস স্টোরেজ)
        if(file) {
            const fileExt = file.name.split('.').pop();
            const fileName = file.name.split('.')[0]; // ফাইল নেমই প্রোডাক্ট কোড
            const fullPath = `${fileName}_${Date.now()}.${fileExt}`;

            const { data: uploadData, error: uploadError } = await supabase.storage
                .from('product-images')
                .upload(fullPath, file);

            if (uploadError) {
                alert("ইমেজ আপলোড এরর: " + uploadError.message);
                btn.disabled = false;
                return;
            }

            const { data: urlData } = supabase.storage
                .from('product-images')
                .getPublicUrl(fullPath);
            
            finalImageUrl = urlData.publicUrl;
        }

        // ডাটাবেসে ডাটা পাঠানো
        const productData = {
            category: document.getElementById('category').value,
            name: document.getElementById('pName').value,
            mrp: parseFloat(document.getElementById('mrp').value),
            discount: parseInt(document.getElementById('discount').value) || 0,
            stock: parseInt(document.getElementById('stock').value),
            quantity: document.getElementById('qtyVal').value,
            unit: document.getElementById('unit').value,
            image_url: finalImageUrl,
            product_code: file ? file.name.split('.')[0] : 'WEB_IMG'
        };

        const { error } = await supabase.from('products').insert([productData]);

        if(error) {
            alert("ডাটাবেস এরর: " + error.message);
        } else {
            alert("প্রোডাক্ট সফলভাবে যোগ করা হয়েছে!");
            location.reload(); // পেজ রিফ্রেশ করে ফর্ম ক্লিয়ার করা
        }
        btn.disabled = false;
        btn.innerText = "OK / সাবমিট করুন";
    };

    // কিবোর্ড এন্টার সাপোর্ট
    document.addEventListener('keypress', (e) => {
        if(e.key === 'Enter' && e.target.id !== 'submitBtn') {
            const currentTab = parseInt(e.target.getAttribute('tabindex'));
            const nextInput = document.querySelector(`[tabindex="${currentTab + 1}"]`);
            if(nextInput) nextInput.focus();
        }
    });
</script>

</body>
</html>
