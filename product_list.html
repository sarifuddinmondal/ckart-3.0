<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <title>Product List - CKART</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f4f4; padding: 20px; }
        h2 { color: #2c3e50; text-align: center; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background: #2c3e50; color: white; }
        tr:hover { background-color: #f1f1f1; }
        img { width: 50px; height: 50px; object-fit: cover; border-radius: 4px; }
        .del-btn { background: none; border: none; cursor: pointer; font-size: 18px; color: #e74c3c; transition: 0.2s; }
        .del-btn:hover { transform: scale(1.2); }
        .loading-text { text-align: center; color: #888; margin-top: 20px; }
    </style>
</head>
<body>
    <h2>Master Product List</h2>
    <div id="loader" class="loading-text">প্রোডাক্ট লোড হচ্ছে...</div>
    
    <table id="p-table" style="display: none;">
        <thead>
            <tr>
                <th>Image</th><th>Code</th><th>Name</th><th>Category</th><th>Price (TK)</th><th>Action</th>
            </tr>
        </thead>
        <tbody id="p-list"></tbody>
    </table>

    <script type="module">
        // আপনার তৈরি করা supabaseClient.js ইম্পোর্ট করা হচ্ছে
        import { supabase } from './supabaseClient.js';

        const listContainer = document.getElementById('p-list');
        const loader = document.getElementById('loader');
        const table = document.getElementById('p-table');

        // ১. ডাটাবেস থেকে প্রোডাক্ট লিস্ট পড়ার ফাংশন
        async function fetchProducts() {
            try {
                const { data: products, error } = await supabase
                    .from('products')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                loader.style.display = "none";
                table.style.display = "table";
                
                renderTable(products);
            } catch (err) {
                console.error("Error fetching products:", err.message);
                loader.innerText = "Error: " + err.message;
            }
        }

        // ২. টেবিল রেন্ডার করার ফাংশন
        function renderTable(products) {
            listContainer.innerHTML = "";
            if (products.length === 0) {
                listContainer.innerHTML = "<tr><td colspan='6' style='text-align:center;'>কোনো প্রোডাক্ট পাওয়া যায়নি।</td></tr>";
                return;
            }

            products.forEach(p => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><img src="${p.image || 'https://via.placeholder.com/50'}" alt="Product"></td>
                    <td>${p.code || p.id}</td>
                    <td><strong>${p.name}</strong></td>
                    <td>${p.category || 'N/A'}</td>
                    <td>${p.price} TK</td>
                    <td><button class="del-btn" onclick="deleteProduct(${p.id})">❌</button></td>
                `;
                listContainer.appendChild(row);
            });
        }

        // ৩. প্রোডাক্ট ডিলিট করার ফাংশন
        window.deleteProduct = async function(id) {
            if (confirm("আপনি কি নিশ্চিতভাবে এই প্রোডাক্টটি মুছে ফেলতে চান?")) {
                try {
                    const { error } = await supabase
                        .from('products')
                        .delete()
                        .eq('id', id);

                    if (error) throw error;
                    
                    alert("প্রোডাক্ট মুছে ফেলা হয়েছে!");
                    fetchProducts(); // টেবিল রিফ্রেশ করা
                } catch (err) {
                    alert("মুছে ফেলতে সমস্যা হয়েছে: " + err.message);
                }
            }
        };

        // ৪. রিয়েল-টাইম আপডেট (কোনো কিছু পরিবর্তন হলে অটো রিফ্রেশ হবে)
        supabase
            .channel('table-db-changes')
            .on('postgres_changes', { event: '*', schema: 'public', table: 'products' }, () => {
                fetchProducts();
            })
            .subscribe();

        // পেজ লোড হলে ডাটা আনা শুরু করবে
        fetchProducts();
    </script>
</body>
</html>